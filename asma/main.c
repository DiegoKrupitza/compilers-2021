#include <stdio.h>
#include <string.h>
#include <mcheck.h>
#include <stdlib.h>

extern void asma_ref(unsigned long x[], unsigned long y[], unsigned long sum[]);
extern void asma_callchecking(unsigned long x[], unsigned long y[], unsigned long sum[]);

void asma_orig(unsigned long x[], unsigned long y[], unsigned long sum[])
{
  unsigned long carry, sum0;
  sum0 = x[0] + y[0];
  carry = sum0 < x[0];
  sum[0] = sum0;
  sum[1] = x[1] + y[1] + carry;
}

int test(unsigned long x[], unsigned long y[])
{
  int i;
  unsigned long x_ref[2], y_ref[2], sum_ref[2], sum[2];
  for (i = 0; i < 2; i++)
  {
    x_ref[i] = x[i];
    y_ref[i] = y[i];
  }
  printf(" 0x%016lx%016lx\n+0x%016lx%016lx", x[1], x[0], y[1], y[0]);
  asma_callchecking(x, y, sum);
  for (i = 0; i < 2; i++)
  {
    if (x_ref[i] != x[i] || y_ref[i] != y[i])
    {
      printf("\nFehler: Eingabe veraendert\n");
      return 0;
    }
  }
  asma_orig(x, y, sum_ref);
  for (i = 0; i < 2; i++)
  {
    if (sum_ref[i] != sum[i])
    {
      printf("\nFehler: Falsche Ausgabe an Stelle %d: Wert: %016lx, erwartet: %016lx\n", i, sum[i], sum_ref[i]);
      return 0;
    }
  }
  printf("\n=0x%016lx%016lx\n\n", sum[1], sum[0]);
  return 1;
}

void myTest()
{
  fprintf(stdout, "My Custom testcases running!\n");
  unsigned long a[] = {95129912, 63941553, 44175337, 83973678, ~22497034, 76800493, 96019688, 4077078, 84158934, 37446472, 24357868, 88013971, 65888094, 93209316, 90210298, 94423413, 17051403, 12088730, 2050957, 6732862, 80982342, 4937305, 24464724, 44799029, ~76665042, 15567415, 25190061, 40693856, 77141802, 19816291, 1101504, 35053613, 57432725, 27797710, 79648758, 28870501, 96147800, 90683832, 19025779, 9999029, 82797421, 6302843, 78046724, 596070, 45309115, 13176894, 45987089, 71777385, 477434, 21898669, 28795090, 68265857, 7006735, 11325183, 43454750, 77168303, 2492142, 35838458, 22727020, 38615195, 95847920, 46045450, 19562731, 97299650, ~57630436, ~51124961, 63210233, 13470488, 6180368, 51690161, 39840460, 97226832, 93073271, 51230479, 49141253, 24181660, 39737698, 80776663, 10807421, 92397786, 63807708, 5429882, 62548890, 38650149, 84368479, 84517553, 49645170, 32145972, 69721963, 28138968, 37948822, 44831536, 73707579, 57950147, 82344216, 94769684, 32374937, 94134681, 99031790, 90984014, 63588714, 99840143, 70945408, 1923165, 39467031, 37394812, 29585881, 33976556, 78988119, 74147514, 30460304, ~93305074, 56013382, 36290118, 74858440, 43121855, 86952545, 34477488, 92724318, 61395182, 90526346, 59127970, 6363944, 31263881, 60206341, 52013147, 73314022, 1992323, 46956682, 94264308, 10852159, 91207539, 67459853, 6713545, 51318787, 96744784, 40238802, 68100740, 68213420, 95272430, 1054268, 62551040, 63550307, 17634730, 7595476, 21079730, 59024035, 53667076, 36220306, 20831219, 41472618, 40518801, 48090210, 66670687, 59671695, 39936968, 40368364, 73738868, 49353255, 81262855, 79341381, 990063, 37217160, 47954400, 87846178, 33151113, 47598040, 32598746, 60621872, 54708638, 86995531, 82239741, 37627083, 42991478, 54988421, 22940094, 98695906, 99672826, 78632625, 54757115, 67003851, 23584108, 80558314, 52592670, 69523233, 56085579, 72310233, 3200088, 24767806, 37562621, 91134813, 72948440, 9909231, 96805221, 75374472, 63686849, 30277148, 19015569, 71255942, 67828958, 40566503, 63271146, 54792732, 99099620, 84976698, 39585465, 22779968, 72975297, 42899209, 77245239, 68468967, 19209620, 89355751, 46551650, 66231394, 63845062, 386789, 42462317, 96765861, 83434304, 15874254, 35123969, 40932264, 2700776, 1427904, 85892332, 23213468, 44140311, 20327306, 65503288, 8138096, 22125462, 7888416, 44749293, 67820657, 35171073, 2331107, 56534014, 52795239, 56513418, 90566440, 74156, 61456173, 15609264, 85497018, 30142880, 13529482, 32496593, 10096051, 62789309, 83111573, 1789034, 1386654, 23744029, 13563062, 68134715, 40565171, 96105544, 13320878, 22190108, 13621765, 90794088, 20017352, 48892239, 58227080, 20379862, 23361760, 48781133, 80115814, 59461810, 55396111, 2760956, 85123188, 10952536, 87427526, 4452680, 52922564, 41759007, 30151480, 76152747, 24415727, 77244437, 97379677, 10349502, 10659706, 83036802, 53493421, 43391626, 26849002, 99232732, 44072160, 22198426, 81900864, 37830359, 68095697, 62426017, 86345524, 441810, 85754273, 58177608, 3380057, 67900947, 26042637, 80726147, 19941382, 15795882, 80579647, 9573192, 20268591, 65529091, 96528739, 19621930, 2154918, 45960825, 43366113, 42780783, 59997659, 74234293, 35657531, 29608551, 85331184, 28459986, 73836785, 38633707, 25574291, 25634088, 1275640, 44376347, 12507273, 21425789, 38188199, 7924615, 9776117, 38589007, 758214, 52921519, 7129828, 9114775, 84842058, 15971157, 32617506, 92153527, 15788732, 5350859, 22801836, 94474734, 14819961, 29632510, 65318774, 10993129, 43535030, 91796089, 85422291, 28578430, 18725127, 7723123, 25471920, 29174375, 11168031, 32601316, 31417184, 90787610, 72445110, 46809284, 88068489, 2931466, 69095593, 99873075, 57009959, 92457269, 66234932, 92039240, 77605182, 89360483, 22536289, 96029082, 57413072, 67857666, 9619676, 48521448, 79854291, 22143280, 57535607, 67483631, 90906010, 73629750, 78217194, 57639279, 10271706, 84163587, 50735838, 90660034, 60760037, 36944248, 1738327, 74926866, 56696167, 39571231, 43190359, 85909963, 62612370, 42997794, 22919128, 22469899, 82054918, 18526222, 27811097, 75325334, 41326790, 43196831, 44447883, 2349710, 29825544, 15221807, 34794899, 14563528, 13626826, 96463169, 16371066, 53307679, 56098944, 99312885, 99238152, 96709999, 81689196, 94916050, 17206772, 52994600, 26275, 51834482, 74562073, 37427902, 22448197, 19052549, 81068305, 7550366, 53429657, 47320707, 82313779, 15380684, 32097409, 87663843, 85997131, 28953197, 33101101, 48252753, 32257357, 27985765, 57044935, 62011599, 89881892, 54931739, 37745278, 88798876, 89555939, 50503795, 3831434, 60301478, 84764300, 23141472, 29729106, 81540086, 63550297, 50712959, 72829609, 58250347, 45501189, 55677654, 74439346, 1698189, 96953931, 2404124, 12259643, 33271595, 79930802, 49902671, 20382951, 98994915, 85174237, 82511874, 1319965, 28755922, 70726217, 93211675, 68586963, 23113797, 18390365, 40095829, 26392261, 21769929, 35173369, 5367113, 64519007, 65353636, 55487080, 67886141, 15580642, 76437009, 25492552, 57260697, ~0};
  unsigned long specialVals[] = {~0, ~0, 1, 1111111111111111, ~1 << 5, 0};
  unsigned long specialLast[] = {~0, ~1};
  int f;
  int counterFail = 0;
  int counterGood = 0;

  f = test(a, a + 1);

  int i;
  for (i = 0; i < 500; i = i + 1)
  {
    f &= test(a, a + i);
    if (!f)
    {
      counterFail++;
    }
    else
    {
      counterGood++;
    }
    f &= test(a + i, a + i);
    if (!f)
    {
      counterFail++;
    }
    else
    {
      counterGood++;
    }

    f &= test(a, specialVals);
    if (!f)
    {
      counterFail++;
    }
    else
    {
      counterGood++;
    }

    f &= test(a, specialVals + 2);
    if (!f)
    {
      counterFail++;
    }
    else
    {
      counterGood++;
    }

    f &= test(a, specialVals + 4);
    if (!f)
    {
      counterFail++;
    }
    else
    {
      counterGood++;
    }

    f &= test(a + i, a);
    if (!f)
    {
      counterFail++;
    }
    else
    {
      counterGood++;
    }

    f &= test(a + i, specialLast);
    if (!f)
    {
      counterFail++;
    }
    else
    {
      counterGood++;
    }

    f &= test(specialLast, a + i);
    if (!f)
    {
      counterFail++;
    }
    else
    {
      counterGood++;
    }
  }

  if (!f)
  {
    fprintf(stdout, "\nCustom Test failed: %d\n", counterFail);
  }
  else
  {
    fprintf(stdout, "\nCustom Test succeeded %d\n", counterGood);
  }

  fprintf(stdout, "\nNumber of Custom tests loops: %d\n", i);
}

int main()
{
  unsigned long a[] = {~0L, 3, 1, 4, 0, 1, 1L << 63, 1L << 63};
  int f;

  f = test(a, a + 2);
  f &= test(a, a + 4);
  f &= test(a + 2, a);
  f &= test(a + 6, a + 6);
  f &= test(a + 2, a + 4);
  f &= test(a + 4, a + 2);
  f &= test(a, a + 6);
  f &= test(a + 6, a);
  if (!f)
    fprintf(stdout, "\nTest failed.\n");
  else
    fprintf(stdout, "\nTest succeeded.\n");

  myTest();
  fprintf(stdout, "\nCustom test done.\n");

  return !f;
}
